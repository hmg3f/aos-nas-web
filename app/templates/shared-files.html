{% extends "base.html" %}

{% block page_title %}File Viewer{% endblock %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css" />
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/diff.css') }}">
{% endblock %}

{% block preload_scripts %}
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js"></script>
{% endblock %}

{% block content %}
<section id="file-view" class="panel">
  <h1>Files</h1>
  <!-- carries current path for JS -->
  <div id="page-data" data-current-path="{{ current_path }}"></div>

  <div class="subpanel" style="padding-top:0">
    <strong>Path:</strong>
    <a href="{{ url_for('/store.get_shared_fs', user_id=user_id) }}">root</a>
    {% set segs = current_path.strip('/').split('/') if current_path.strip('/') else [] %}
    {% set acc = '' %}
    {% for s in segs %}
      {% set acc = acc + '/' + s %}
      / <a href="{{ url_for('/store.get_shared_fs', path=acc, user_id=user_id) }}">{{ s }}</a>
    {% endfor %}
  </div>

  <table>
    <thead>
      <tr>
	<th style="width: 0;">
          <input type="checkbox" id="select-all" autocomplete="off">
	  <img src="{{ url_for('static', filename='asset/trash-can.svg') }}" alt="Delete" width="15px" height="15px">
        </th>
	<th>Name</th>
	<th style="width: 0;">Owner</th>
	<th style="width: 0;">Group</th>
	<th style="width: 0;">Size</th>
	<th style="width: 0;">Permissions</th>
      </tr>
    </thead>
    <tbody>
      {% if current_path != '/' %}
      {% set parent = '/' if not current_path.strip('/').count('/') else '/' + '/'.join(current_path.strip('/').split('/')[:-1]) %}
      <tr>
        <td></td>
        <td>
	  <a href="{{ url_for('/store.get_shared_fs', path=parent, user_id=user_id) }}" class="overflow-hidden">..</a>
	</td>
        <td colspan="4"></td>
      </tr>
      {% endif %}

      <!-- Files (only for current directory) -->
      {% for item in file_list %}
      <tr>
	<td>
	  <input type="checkbox"
		 class="file-checkbox"
		 data-id="{{ item.id }}"
		 autocomplete="off">
	</td>
	<td>
	  {% if item.is_directory %}
          <a href="{{ url_for('/store.get_shared_fs',
		   user_id=user_id, path=(current_path.rstrip('/') ~ '/' ~ item.name).replace('//','/')) }}"
	     class="overflow-hidden file-listing"
	     data-id="{{ item.id }}"
	     data-dir="{{ item.is_directory }}"
	     data-perms="{{ item.permissions }}"
	     data-group="{{ item.file_group }}"
	     data-user="{{ current_user.id }}"
	     data-name="{{ item.name }}">
	    üìÅ {{ item.name }}/
	  </a>
	  {% else %}
          <a href="{{ url_for('/store.download_file', user_id=user_id, file_id=item.id) }}"
	     class="overflow-hidden file-listing"
	     data-id="{{ item.id }}"
	     data-dir="{{ item.is_directory }}"
	     data-perms="{{ item.permissions }}"
	     data-group="{{ item.file_group }}"
	     data-user="{{ user_id }}"
	     data-name="{{ item.name }}">
            {{ item.name }}
          </a>
	  {% endif %}
	</td>
	<td>{{ item.owner }}</td>
	<td>{{ item.file_group }}</td>
	<td>{{ item.size }}</td>
	<td>{{ item.permissions }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div id="file-context-menu" style="display:none; position:absolute; z-index:1000;">
    <ul>
      <li><a href="#" id="download-option">Download</a></li>
      <li><a href="#" id="rename-option">Rename</a></li>
      <li><a href="#" id="edit-perms-option">Edit Permissions</a></li>
    </ul>
  </div>

  <div id="fs-stats" class="subpanel">
    <h2>Filesystem Stats:</h2>
    <div class="stat-block">
      File Count: {{ fs_stats.file_count }}
    </div>
    <div class="stat-block">
      Size: {{ fs_stats.stage_size }}
    </div>
    <div class="stat-block">
      Repo Size: {{ fs_stats.repo_size }}
    </div>
    {% if fs_stats.quota %}
    <div class="stat-block">
      quota: {{ fs_stats.quota }}
    </div>
    {% endif %}
    {% if fs_stats.percent_used %}
    <div class="stat-block">
      Percent Used: {{ fs_stats.percent_used }}%
    </div>
    {% endif %}
  </div>
</section>

<section id="toolbox" class="panel">
  <h1>Toolbox</h1>
  <div class="content">
    <div class="user_info">
      <span>Currently logged in as: </span>
      {% if current_user.has_flag(1) %}
      <span style="color: #9d1f1f">{{ current_user.username }}</span>
      {% else %}
      <span style="color: #a0afef">{{ current_user.username }}</span>
      {% endif %}
    </div>
    <div class="controls">
      <a href="{{ url_for('/store.file_viewer') }}">‚óÄ Return</a>
      <button id="delete-button" data-user="{{ user_id }}" disabled>Delete Selected</button>
    </div>
  </div>
</section>

<section id="set-perms-prompt" class="prompt">
  <h1>Edit Permissions</h1>
  <div class="content">
    <form id="set-perms-form">
      <div class="form-group">
	<label for="set-group-input">File Group:</label>
	<input type="text" id="set-group-input" name="set-group">
      </div>
      
      <div class="form-group">
	<label for="set-perms-input">File Permissions (octal):</label>
	<input type="text" id="set-perms-input" name="set-group">
      </div>

      <div class="form-group">
	<input type="submit" id="set-perms-submit" name="submit-perms">
      </div>
    </form>
  </div>
</section>

<section id="rename-prompt" class="prompt">
  <h1>Edit Filename</h1>
  <div class="content">
    <form method="POST" id="rename-form">
      <div class="form-group">
	<label for="rename-input">Set name:</label>
	<input type="text" id="rename-input" name="rename">
      </div>

      <div class="form-group">
	<input type="submit" id="rename-submit" name="submit-rename">
      </div>
    </form>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/file-delete.js') }}"></script>
<script src="{{ url_for('static', filename='js/file-context.js') }}"></script>
{% endblock %}

