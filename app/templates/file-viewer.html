{% extends "base.html" %}

{% block page_title %}File Viewer{% endblock %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css" />
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/diff.css') }}">
{% endblock %}

{% block preload_scripts %}
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js"></script>
{% endblock %}

{% block content %}
<section id="file-view" class="panel">
  <h1>Files</h1>
  <!-- carries current path for JS -->
  <div id="page-data" data-current-path="{{ current_path }}"></div>

  <div class="subpanel" style="padding-top:0">
    <!-- breadcrumbs -->
    <strong>Path:</strong>
    <a href="{{ url_for('/store.file_viewer') }}">root</a>
    {% set segs = current_path.strip('/').split('/') if current_path.strip('/') else [] %}
    {% set acc = '' %}
    {% for s in segs %}
    {% set acc = acc + '/' + s %}
    / <a href="{{ url_for('/store.file_viewer', path=acc) }}">{{ s }}</a>
    {% endfor %}
  </div>

  <table>
    <thead>
      <tr>
	<th style="width: 0;">
          <input type="checkbox" id="select-all" autocomplete="off">
	  <img src="{{ url_for('static', filename='asset/trash-can.svg') }}" alt="Delete" width="15px" height="15px">
        </th>
	<th>Name</th>
	<th style="width: 0;">Owner</th>
	<th style="width: 0;">Group</th>
	<th style="width: 0;">Size</th>
	<th style="width: 0;">Permissions</th>
      </tr>
    </thead>
    <tbody>
      <!-- parent dir -->
      {% if current_path != '/' %}
      {% set parent = '/' if not current_path.strip('/').count('/') else '/' + '/'.join(current_path.strip('/').split('/')[:-1]) %}
      <tr>
        <td></td>
        <td><a href="{{ url_for('/store.file_viewer', path=parent) }}" class="overflow-hidden">..</a></td>
        <td colspan="4"></td>
      </tr>
      {% endif %}

      <!-- Files (only for current directory) -->
      {% for item in file_list %}
      <tr>
	<td>
	  <input type="checkbox" class="file-checkbox" data-filename="{{ item.name }}" autocomplete="off">
	</td>
	<td>
	  {% if item.is_directory %}
          <a href="{{ url_for('/store.file_viewer',
		   path=(current_path.rstrip('/') ~ '/' ~ item.name).replace('//','/')) }}"
	     class="overflow-hidden file-listing"
	     data-id="{{ item.id }}"
	     data-dir="{{ item.is_directory }}"
	     data-perms="{{ item.permissions }}"
	     data-group="{{ item.file_group }}"
	     data-user="{{ current_user.id }}">
	    üìÅ {{ item.name }}/
	  </a>
	  {% else %}
          <a href="{{ url_for('/store.download_file', user_id=current_user.id, file_id=item.id) }}"
	     class="overflow-hidden file-listing"
	     data-id="{{ item.id }}"
	     data-dir="{{ item.is_directory }}"
	     data-perms="{{ item.permissions }}"
	     data-group="{{ item.file_group }}"
	     data-user="{{ current_user.id }}">
            {{ item.name }}
          </a>
	  {% endif %}
	</td>
	<td>{{ item.owner }}</td>
	<td>{{ item.file_group }}</td>
	<td>{{ item.size }}</td>
	<td>{{ item.permissions }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div id="file-context-menu" style="display:none; position:absolute; z-index:1000;">
    <ul>
      <li><a href="#" id="download-option">Download</a></li>
      <li><a href="#" id="rename-option">Rename</a></li>
      <li><a href="#" id="edit-perms-option">Edit Permissions</a></li>
    </ul>
  </div>
</section>

<section id="toolbox" class="panel">
  <h1>Toolbox</h1>
  <div class="content">
    <div class="controls">
      <a href="{{ url_for('/auth.logout') }}">‚óÄ Logout</a>
      <a href="{{ url_for('/auth.account_manager') }}">Account Management</a>
      <button id="delete-button" disabled>Delete Selected</button>
    </div>
  </div>
</section>

<div class="fs-controller">
  <section id="new-folder" class="panel">
    <h1>New Folder</h1>
    <div class="content">
      <div class="form-group">
	<input type="text" id="new-folder-name" placeholder="Folder name" required>
	<button id="create-folder-button">Create Folder</button>
      </div>
      <div id="folder-status"></div>
    </div>
  </section>

  <section id="file-upload" class="panel">
    <h1>Upload File</h1>
    <div class="content">
      <form method="POST" id="upload-form" action="{{ url_for('/store.add_file') }}" enctype="multipart/form-data">
	<input type="hidden" name="path" id="upload-path" value="{{ current_path }}">

	<div class="form-group">
          <label for="file-input">Choose file:</label>
          <input type="file" name="file" multiple required>
	</div>

	<div class="form-group">
	  <label for="group-input">File group:</label>
	  <input type="text" id="group-input" name="group" value="{{ current_user.username }}" required>
	</div>

	<div class="form-group">
          <label>Permissions:</label>
          <div class="permissions-grid">
            <div class="perm-header"></div>
            <div class="perm-header">User</div>
            <div class="perm-header">Group</div>
            <div class="perm-header">Everyone</div>
            
            <div class="perm-label">Read</div>
            <input type="checkbox" name="perm_user_read" checked>
            <input type="checkbox" name="perm_group_read" checked>
            <input type="checkbox" name="perm_everyone_read">
            
            <div class="perm-label">Write</div>
            <input type="checkbox" name="perm_user_write" checked>
            <input type="checkbox" name="perm_group_write">
            <input type="checkbox" name="perm_everyone_write">
            
            <div class="perm-label">Execute</div>
            <input type="checkbox" name="perm_user_execute" checked>
            <input type="checkbox" name="perm_group_execute">
	    <input type="checkbox" name="perm_everyone_execute">
	  </div>
	  
	  <div class="permission-display">
	    Octal: <span id="octal-display">740</span>
	  </div>
	  
	  <button type="submit">Upload</button>
	</div>
	
	<div id="upload-status"></div>
      </form>
    </div>
  </section>

  <section id="archive-manager" class="panel">
    <h1>Archive Manager</h1>

    <div class="content">
      <div class="selector">
	<button id="previous-archive" class="archive-nav" disabled>‚óÄ</button>
	<select id="archive-selector">
	  {% for archive in archive_list %}
	  <option value="{{ archive['id'] }}">{{ archive['name'] }}</option>
	  {% endfor %}
	  <option value="" disabled selected>select previous archive...</option>
	</select>
	<button id="next-archive" class="archive-nav">‚ñ∂</button>
      </div>

      <div id="diff-panel">
	<h3>Diff View</h3>
	<div id="diff-viewer"></div>
      </div>
      
      <button id="revert-archive" disabled>Revert to Archive</button>
    </div>
  </section>

  <section id="shared-files" class="panel">
    <h1>Access Shared Files</h1>

    <div class="content">
      <form method="POST">
	{{ shareform.hidden_tag() }}

	<div>
          <label for="owner">{{ shareform.owner.label }}</label>
          {{ shareform.owner() }}
	</div>
	<div>
          {{ shareform.submit() }}
	</div>
      </form>
    </div>
  </section>

  <section id="set-perms-prompt" class="prompt">
    <h1>Edit Permissions</h1>
    <div class="content">
      <div class="form-group">
	<label for="set-group-input">File Group:</label>
	<input type="text" id="set-group-input" name="set-group">
      </div>
      
      <div class="form-group">
	<label for="set-perms-input">File Permissions (octal):</label>
	<input type="text" id="set-perms-input" name="set-group">
      </div>

      <div class="form-group">
	<button type="submit" id="set-perms-submit" name="submit-perms">Update Permissions</button>
      </div>
    </div>
  </section>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dir-manager.js') }}"></script>
<script src="{{ url_for('static', filename='js/upload-handler.js') }}"></script>
<script src="{{ url_for('static', filename='js/file-delete.js') }}"></script>
<script src="{{ url_for('static', filename='js/archive-select.js') }}"></script>
<script src="{{ url_for('static', filename='js/file-context.js') }}"></script>
{% endblock %}

